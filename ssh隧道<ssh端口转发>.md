# ssh 端口转发

类似mysql等服务，在公网链路上的数据是不加密的，通过ssh进行端口转发，在转发完成前，数据是被ssh加密过的

三个冒号
接收IP：接收PORT：启动服务的IP：启动服务的PORT
本地转发 -L 本机IP：本机PORT：远程IP：远程PORT  # 远程端口开服务，做了转发以后，本地访问本地端口，就会拿到远程的服务
远程转发 -R <远程IP不用写>:远程端口:本地IP:本地端口  # 本地端口开了服务，做了转发，访问远程的端口，就会拿到本地的服务


## 本地转发
> 两个机器
> 
> 公网机器A<47.116.14.62> 在80端口随意启动一个服务
> 
> 局域网机器B<192.168.233.132> 可以上公网
> 

```bash
# ssh 参数解释

# -L 表示使用本地端口转发创建ssh隧道
# -R 表示使用远程端口转发创建ssh隧道
# -N 创建隧道以后不连接到sshServer端，通常与”-f”选项连用
# -f 后台运行ssh隧道，通常与”-N”选项连用
# -g 开启网关模式,ssh隧道对应的转发端口将监听在主机的所有IP中, 远程端口转发中，无法开启网关功能。


# 在B主机运行
# ssh -L <BIP,省略则是127.0.0.1>:<BPORT>:<AIP>:<APORT> <AUSER>@<AIP>
# 将A主机的端口APORT转发至B主机的BIP网段中的BPORT端口
# 即 B主机访问<127.0.0.1:8080> 其实是访问的A主机的80端口
ssh -L 127.0.0.1:8080:47.116.14.62:80 root@47.116.14.62
# 命令执行后输入密码，建立ssh连接，保持连接，B主机访问127.0.0.1：8080可看到A主机80端口开启的服务

# 连接断开则无法继续转发断开
# ssh -N -f -L <BIP,省略则是127.0.0.1>:<BPORT>:<AIP>:<APORT> <AUSER>@<AIP>
ssh -N -f -L 127.0.0.1:8080:47.116.14.62:80 root@47.116.14.62

# 想要B主机所属网段的其它主机也可以访问，则使用B主机的在子网中所属的IP,B主机防火墙要开放8080端口
ssh -N -f -L 192.168.233.132:8080:47.116.14.62:80 root@47.116.14.62

# 网关模式,B主机每个网卡对于的8080端口都可以访问
ssh -N -f -g -L :8080:47.116.14.62:80 root@47.116.14.62

```

## 远程转发
> 两个机器
> 
> 公网机器A<47.116.14.62> 
> 
> 局域网机器B<192.168.233.132> 在80端口随意启动一个服务
> 
> 在不做内网穿透的情况下，想让A机器访问B机器80端口

用远程转发，在B机器上操作，将本机的端口转发到A机器

```bash
ssh -N -f -R :8080:127.0.0.1:80 root@47.116.14.62
```

> 即使指定了公网服务器的地址，监听的IP依然只是本地回环127.0.0.1
> 
> ssh -N -f -R 47.116.14.62:8080:127.0.0.1:80 root@47.116.14.62 这样子是没用的
> 

> 变相的内网穿透
> 
> 听说：这种情况的远程转发不是很稳定，尤其当局域网机器没有特定的IP时，ssh服务会经常断掉，有人建议使用autossh解决这种问题。
